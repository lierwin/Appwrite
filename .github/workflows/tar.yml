name: Build and Release Appwrite

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/main.js'
      - 'package.json'
      - 'Dockerfile'
      - 'index.html'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Validate required files
      run: |
        for file in \
          src/main.js \
          package.json \
          Dockerfile \
          index.html
        do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing file: $file"
            exit 1
          fi
        done
        echo "âœ… All required files found"

    - name: Display file info
      run: |
        echo "ðŸ“‹ Root files:"
        ls -la
        echo "ðŸ“ src/"
        ls -la src/

    - name: Create deployment archive
      run: |
        tar -czf Appwrite.tar.gz \
          src/main.js \
          package.json \
          Dockerfile \
          index.html

        echo "ðŸ“¦ Archive created: Appwrite.tar.gz"
        echo "ðŸ“Š Size: $(du -h Appwrite.tar.gz | cut -f1)"

    - name: Verify archive contents
      run: |
        echo "ðŸ” Archive contents:"
        tar -tzf Appwrite.tar.gz

    - name: Generate release notes
      run: |
        cat > release_notes.md << EOF
        ## ðŸš€ Appwrite Functions éƒ¨ç½²åŒ…

        **åŒ…å«æ–‡ä»¶ï¼š**
        - src/main.js
        - package.json
        - Dockerfile
        - index.html

        ç›´æŽ¥ä¸Šä¼  Appwrite ä½¿ç”¨
        EOF

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: Appwrite-latest
        name: Appwrite Functions
        body_path: release_notes.md
        files: Appwrite.tar.gz
        make_latest: true
        overwrite: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        echo "ðŸŽ‰ æž„å»º & å‘å¸ƒå®Œæˆ"
        echo "ðŸ“¦ Appwrite.tar.gz"
