name: Build and Release Appwrite

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/main.js'
      - 'package.json'
      - 'main/Dockerfile'
      - 'main/index.html'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Validate required files
      run: |
        for file in \
          src/main.js \
          package.json \
          main/Dockerfile \
          main/index.html
        do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing file: $file"
            exit 1
          fi
        done
        echo "âœ… All required files found"

    - name: Display file info
      run: |
        echo "ðŸ“‹ Files to be packaged:"
        ls -la src/
        ls -la main/

    - name: Create package directory
      run: |
        mkdir -p Appwrite/src Appwrite/main

    - name: Copy files to package directory
      run: |
        cp src/main.js Appwrite/src/
        cp package.json Appwrite/
        cp main/Dockerfile Appwrite/main/
        cp main/index.html Appwrite/main/

        echo "ðŸ“ Appwrite directory structure:"
        find Appwrite -type f

    - name: Create deployment archive
      run: |
        tar -czf Appwrite.tar.gz \
          Appwrite/src/main.js \
          Appwrite/package.json \
          Appwrite/main/Dockerfile \
          Appwrite/main/index.html

        echo "ðŸ“¦ Archive created: Appwrite.tar.gz"
        echo "ðŸ“Š Size: $(du -h Appwrite.tar.gz | cut -f1)"

    - name: Verify archive contents
      run: |
        echo "ðŸ” Archive contents:"
        tar -tzf Appwrite.tar.gz

    - name: Generate release notes
      run: |
        cat > release_notes.md << EOF
        ## ðŸš€ Appwrite Functions éƒ¨ç½²åŒ…

        **åŒ…å«å†…å®¹ï¼š**
        - src/main.js
        - package.json
        - main/Dockerfile
        - main/index.html

        ä¸Šä¼ åˆ° Appwrite Functions ç›´æŽ¥ä½¿ç”¨ã€‚
        EOF

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: Appwrite-latest
        name: Appwrite Functions
        body_path: release_notes.md
        files: Appwrite.tar.gz
        make_latest: true
        overwrite: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        echo "ðŸŽ‰ æž„å»º & å‘å¸ƒå®Œæˆ"
        echo "ðŸ“¦ Appwrite.tar.gz"
